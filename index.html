document.addEventListener('DOMContentLoaded', () => {
    const choice1Button = document.getElementById('choice1');
    const choice2Button = document.getElementById('choice2');
    const skipButton = document.getElementById('skip-button');
    const startOverButton = document.getElementById('start-over-button');
    const resultsArea = document.getElementById('results-area');
    const tierList = document.getElementById('tier-list');
    const restartButton = document.getElementById('restart-button');
    const progressCounter = document.getElementById('progress-counter');
    const gameArea = document.getElementById('game-area');

    const initialNames = [
        "amen",
        "Toy Patriot",
        "KARMA CITY",
        "Go Go Yuureisen/Go Go Ghost Ship",
        "Fuefukedomo Odorazu/Flute Without Dancing",
        "Machi/Town",
        "Kubi-nashi Kankodori/Headless Cuckoo",
        "PLACEBO",
        "Black Sheep",
        "爱丽丝 (Alice)",
        "Will-O-Wisp",
        "Kanden/Shock",
        "Dagashi-ya Shoubai/Cheap Sweets Selling",
        "Hopeland",
        "Sange no Machi/Repentance Town",
        "Kokoro ni Kudamono/Fruit for the Heart",
        "Undercover",
        "Ame no Gairo ni Yakouchuu/Night Bugs on a Rainy Street",
        "Yasashii Hito/Kind Person",
        "Mirage Song",
        "Petrichor",
        "Umi no Yuurei/Ghost of the Sea",
        "Hana ni Arashi/Flower and Storm",
        "Lullabye Goodbye",
        "Shunrai/Spring Thunder",
        "Hien/Flying Swallow",
        "love",
        "Santa Maria",
        "Living Dead Youth",
        "Fluorite",
        "Cranberry and Pancakes",
        "Moonlight",
        "Gomen Ne/I'm Sorry",
        "Flamingo",
        "Neon Sign",
        "Himawari/Sunflower",
        "Saijouei/Rerun",
        "Tabibito Dentou/Traveler's Lamp",
        "LOSER",
        "Nighthawks",
        "Unbelievers",
        "Ganpuku/Sight for Sore Eyes",
        "Shitodo Seiten Daimeiwaku/The Trouble of Dripping Wet Sun",
        "Hisui no Ookami/Jade Wolf",
        "Shinzou Houei/Mental Television",
        "MAD HEAD LOVE",
        "Haiiro to Ao/Gray and Blue",
        "Melancholy Kitchen",
        "TEENAGE RIOT",
        "Eine Kleine",
        "orion",
        "Machigai Sagashi/Spot the Difference",
        "fogbound",
        "Hikarabita Basu Hitotsu/One Stale Bus",
        "Poppin' Apathy",
        "Horafuki Nekoyarou/Braggart Alleycats",
        "Tori ni demo Naritai/Wanna Be A Bird At Least",
        "Shouhon/Excerpt",
        "Atashi wa Yuurei/I'm A Ghost",
        "Campanella",
        "Paper Flower",
        "Canary",
        "WOODEN DOLL",
        "Mayoeru Hitsuji/Stray Sheep",
        "Uchiage Hanabi/Fireworks",
        "Hyakkiyakou/Pandemonium",
        "Number Nine",
        "Amefuri Fujin/Rain Woman",
        "Disco Balloon",
        "Paprika",
        "Donut Hole",
        "Desho Masho/Let's / Isn't It",
        "Peace Sign",
        "TOXIC BOY",
        "Blue Jasmine",
        "Neighbourhood",
        "Umi to Sanshouuo/The Sea and the Salamander",
        "Caribou",
        "Metronome",
        "Suna no Wakusei/Sand Planet",
        "Flowerwall",
        "Lemon",
        "Koi to Byounetsu/Love and Fever",
        "Décolleté",
        "Uma to Shika/Horse and Deer",
        "Vivi",
        "Cinderella Gray",
        "Pale Blue",
        "Yume Utsutsu/Half-Dreaming",
        "Shinigami",
        "POP SONG",
        "M87",
        "ETA",
        "KICK BACK",
        "Hazukashikutte Shou ga Nee/Y'all Should Be Ashamed",
        "LADY",
        "Tsuki o Miteita/Moongazing",
        "Chikyuugi/Globe",
        "Sayoonara Mata Itsuka!/Bye Now, See You Someday!",
        "Mainichi/Every Day",
        "RED OUT",
        "Garakuta/Junk",
        "Margherita",
        "Tomare Miyo/Stop, Look Both Ways",
        "LENS FLARE",
        "YELLOW GHOST",
        "POST HUMAN",
        "LOST CORNER",
        "Azalea",
        "BOW AND ARROW",
        "Plazma"
    ];

    let names = [...initialNames];
    let preferences = {};
    let comparisons = new Set();
    let currentPair = [];
    let roundNum = 0;
    const maxRoundsMultiplier = 5;

    // --- Local Storage Keys ---
    const PREFERENCES_KEY = 'tierListPreferences';
    const COMPARISONS_KEY = 'tierListComparisons';

    // --- Load Saved Progress ---
    function loadProgress() {
        const savedPreferences = localStorage.getItem(PREFERENCES_KEY);
        const savedComparisons = localStorage.getItem(COMPARISONS_KEY);

        if (savedPreferences && savedComparisons) {
            preferences = JSON.parse(savedPreferences);
            comparisons = new Set(JSON.parse(savedComparisons));
            if (Object.keys(preferences).length > 0) {
                document.getElementById('game-area').style.display = 'block';
                updateProgress(); // Initial progress update
                choosePair(); // Resume the game
            } else {
                startGame();
            }
        } else {
            startGame();
        }
    }

    // --- Save Progress ---
    function saveProgress() {
        localStorage.setItem(PREFERENCES_KEY, JSON.stringify(preferences));
        localStorage.setItem(COMPARISONS_KEY, JSON.stringify(Array.from(comparisons)));
        updateProgress(); // Update progress on save
    }

    function startGame() {
        names.forEach(name => preferences[name] = 0);
        document.getElementById('game-area').style.display = 'block';
        updateProgress(); // Initial progress update
        choosePair();
    }

    function choosePair() {
        const totalPossibleComparisons = (names.length * (names.length - 1)) / 2;

        if (comparisons.size >= totalPossibleComparisons) {
            showResults();
            return null;
        }

        const availableNames = names.filter(name => {
            const maxPreference = Object.values(preferences).length > 0 ? Math.max(...Object.values(preferences)) : 0;
            return !(preferences[name] >= maxPreference + 2 && Object.keys(preferences).length > 2);
        });

        if (availableNames.length < 2) {
            showResults();
            return null;
        }

        let name1, name2;
        do {
            const sample = getRandomSubset(availableNames, 2);
            name1 = sample[0];
            name2 = sample[1];
        } while (comparisons.has(name1 + '-' + name2) || comparisons.has(name2 + '-' + name1));

        currentPair = [name1, name2];
        choice1Button.textContent = name1;
        choice2Button.textContent = name2;
        return currentPair;
    }

    function updateProgress() {
        const totalPossibleComparisons = (names.length * (names.length - 1)) / 2;
        const progressPercentage = Math.min(100, Math.round((comparisons.size / totalPossibleComparisons) * 100));
        progressCounter.textContent = `Progress: ${comparisons.size} / ${totalPossibleComparisons} (${progressPercentage}%)`;
    }

    function getRandomSubset(array, size) {
        const shuffled = [...array].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, size);
    }

    choice1Button.addEventListener('click', () => {
        if (currentPair.length === 2) {
            preferences[currentPair[0]]++;
            comparisons.add(currentPair[0] + '-' + currentPair[1]);
            saveProgress();
            choosePair();
        }
    });

    choice2Button.addEventListener('click', () => {
        if (currentPair.length === 2) {
            preferences[currentPair[1]]++;
            comparisons.add(currentPair[0] + '-' + currentPair[1]);
            saveProgress();
            choosePair();
        }
    });

    skipButton.addEventListener('click', () => {
        if (currentPair.length === 2) {
            preferences[currentPair[0]] += 0.5; // Slight preference for both
            preferences[currentPair[1]] += 0.5;
            comparisons.add(currentPair[0] + '-' + currentPair[1]);
            saveProgress();
            choosePair();
        }
    });

    startOverButton.addEventListener('click', () => {
        names = [...initialNames];
        preferences = {};
        comparisons.clear();
        localStorage.removeItem(PREFERENCES_KEY);
        localStorage.removeItem(COMPARISONS_KEY);
        startGame();
    });

    function showResults() {
        gameArea.style.display = 'none';
        resultsArea.style.display = 'block';
        const sortedNames = Object.entries(preferences).sort(([, a], [, b]) => b - a);
        tierList.innerHTML = '';
        sortedNames.forEach(([name, score], index) => {
            const listItem = document.createElement('li');
            listItem.textContent = `${index + 1}. ${name} (Wins: ${score.toFixed(1)})`; // Display score with one decimal
            tierList.appendChild(listItem);
        });
        localStorage.removeItem(PREFERENCES_KEY);
        localStorage.removeItem(COMPARISONS_KEY);
    }

    restartButton.addEventListener('click', () => {
        resultsArea.style.display = 'none';
        names = [...initialNames];
        preferences = {};
        comparisons.clear();
        localStorage.removeItem(PREFERENCES_KEY);
        localStorage.removeItem(COMPARISONS_KEY);
        startGame();
    });

    // --- Initialize: Load progress or start new game ---
    loadProgress();
});
